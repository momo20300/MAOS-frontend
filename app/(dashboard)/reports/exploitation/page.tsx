"use client";

import { useEffect, useState, useCallback } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { authFetch } from "@/lib/services/auth";
import { cn } from "@/lib/utils";
import {
  TrendingUp, DollarSign, ShoppingCart, Wallet, Download,
  Loader2, RefreshCw, Calendar, FileText, ArrowUpRight, ArrowDownRight,
} from "lucide-react";
import {
  BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid,
  Tooltip, Legend, ResponsiveContainer, ComposedChart, Area,
} from "recharts";

// ── Types ──────────────────────────────────────────────────

interface ExploitationData {
  period: { startDate: string; endDate: string };
  summary: {
    revenue: number;
    costsPO: number;
    costsPINV: number;
    grossMargin: number;
    marginRate: number;
    amountCollected: number;
    amountDue: number;
    invoiceCount: number;
    poCount: number;
    pinvCount: number;
    paymentCount: number;
  };
  topClients: Array<{ name: string; total: number; count: number; pct: number }>;
  topSuppliers: Array<{ name: string; totalPO: number; totalPINV: number; countPO: number; countPINV: number }>;
  monthly: Array<{ month: string; key: string; revenue: number; costs: number; margin: number; collected: number }>;
}

// ── Helpers ────────────────────────────────────────────────

function fmtMAD(n: number): string {
  if (!n && n !== 0) return "0 DH";
  return Math.round(n).toLocaleString("fr-FR") + " DH";
}

function fmtCompact(n: number): string {
  const abs = Math.abs(n);
  const sign = n < 0 ? "-" : "";
  if (abs >= 1_000_000) return `${sign}${(abs / 1_000_000).toFixed(1)}M`;
  if (abs >= 10_000) return `${sign}${(abs / 1_000).toFixed(0)}K`;
  if (abs >= 1_000) return `${sign}${(abs / 1_000).toFixed(1)}K`;
  return Math.round(n).toLocaleString("fr-FR");
}

function fmtPct(n: number): string {
  return n.toFixed(1) + "%";
}

function dateStr(d: Date): string {
  return d.toISOString().split("T")[0]!;
}

// ── Date presets ──────────────────────────────────────────

function getPresetDates(preset: string): { start: string; end: string } {
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();

  switch (preset) {
    case "this-month":
      return { start: dateStr(new Date(y, m, 1)), end: dateStr(now) };
    case "last-month":
      return { start: dateStr(new Date(y, m - 1, 1)), end: dateStr(new Date(y, m, 0)) };
    case "this-quarter": {
      const q = Math.floor(m / 3) * 3;
      return { start: dateStr(new Date(y, q, 1)), end: dateStr(now) };
    }
    case "this-year":
      return { start: `${y}-01-01`, end: dateStr(now) };
    case "last-year":
      return { start: `${y - 1}-01-01`, end: `${y - 1}-12-31` };
    case "last-12":
    default:
      return { start: dateStr(new Date(y - 1, m, 1)), end: dateStr(now) };
  }
}

const PRESETS = [
  { id: "this-month", label: "Ce mois" },
  { id: "last-month", label: "Mois dernier" },
  { id: "this-quarter", label: "Ce trimestre" },
  { id: "this-year", label: "Cette annee" },
  { id: "last-year", label: "Annee derniere" },
  { id: "last-12", label: "12 derniers mois" },
];

// ── Tooltip formatter ──────────────────────────────────────

const CustomTooltip = ({ active, payload, label }: any) => {
  if (!active || !payload) return null;
  return (
    <div className="bg-white dark:bg-gray-800 border rounded-lg shadow-lg p-3 text-sm">
      <p className="font-semibold mb-1">{label}</p>
      {payload.map((entry: any, i: number) => (
        <p key={i} style={{ color: entry.color }}>
          {entry.name}: {fmtMAD(entry.value)}
        </p>
      ))}
    </div>
  );
};

// ── Page Component ────────────────────────────────────────

export default function ExploitationReportPage() {
  const [data, setData] = useState<ExploitationData | null>(null);
  const [loading, setLoading] = useState(true);
  const [pdfLoading, setPdfLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [activePreset, setActivePreset] = useState("last-12");

  // Default: last 12 months
  const defaultDates = getPresetDates("last-12");
  const [startDate, setStartDate] = useState(defaultDates.start);
  const [endDate, setEndDate] = useState(defaultDates.end);

  const fetchData = useCallback(async (start: string, end: string) => {
    setLoading(true);
    setError(null);
    try {
      const res = await authFetch(`/api/reports/exploitation?startDate=${start}&endDate=${end}`);
      if (!res.ok) throw new Error(`Erreur ${res.status}`);
      const json = await res.json();
      if (!json.success) throw new Error(json.error || "Erreur inconnue");
      setData(json.data);
    } catch (e: any) {
      setError(e.message || "Erreur de chargement");
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchData(startDate, endDate);
  }, []);

  const handlePreset = (presetId: string) => {
    setActivePreset(presetId);
    const { start, end } = getPresetDates(presetId);
    setStartDate(start);
    setEndDate(end);
    fetchData(start, end);
  };

  const handleCustomDates = () => {
    setActivePreset("");
    fetchData(startDate, endDate);
  };

  const downloadPDF = async () => {
    setPdfLoading(true);
    try {
      const res = await authFetch("/api/reports/exploitation/pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ startDate, endDate }),
      });
      if (!res.ok) throw new Error(`Erreur ${res.status}`);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
    } catch (e) {
      console.error("PDF generation failed:", e);
    } finally {
      setPdfLoading(false);
    }
  };

  const s = data?.summary;

  return (
    <div className="p-6 max-w-7xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold flex items-center gap-2">
            <TrendingUp className="h-7 w-7 text-emerald-500" />
            Rapport d&apos;Exploitation
          </h1>
          <p className="text-muted-foreground mt-1">
            Synthese de l&apos;activite commerciale et financiere
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={() => fetchData(startDate, endDate)}
            disabled={loading}
          >
            <RefreshCw className={cn("h-4 w-4 mr-1", loading && "animate-spin")} />
            Actualiser
          </Button>
          <Button
            size="sm"
            onClick={downloadPDF}
            disabled={pdfLoading || !data}
            className="bg-emerald-600 hover:bg-emerald-700 text-white"
          >
            {pdfLoading ? (
              <Loader2 className="h-4 w-4 animate-spin mr-1" />
            ) : (
              <Download className="h-4 w-4 mr-1" />
            )}
            Telecharger PDF
          </Button>
        </div>
      </div>

      {/* Date selector bar */}
      <Card>
        <CardContent className="p-4">
          <div className="flex flex-col md:flex-row items-center gap-3">
            <Calendar className="h-4 w-4 text-muted-foreground shrink-0" />
            <div className="flex flex-wrap gap-2">
              {PRESETS.map((p) => (
                <Button
                  key={p.id}
                  size="sm"
                  variant={activePreset === p.id ? "default" : "outline"}
                  className={cn(
                    "text-xs h-8",
                    activePreset === p.id && "bg-emerald-600 hover:bg-emerald-700 text-white"
                  )}
                  onClick={() => handlePreset(p.id)}
                >
                  {p.label}
                </Button>
              ))}
            </div>
            <div className="flex items-center gap-2 ml-auto">
              <Input
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                className="w-36 h-8 text-xs"
              />
              <span className="text-muted-foreground text-xs">au</span>
              <Input
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                className="w-36 h-8 text-xs"
              />
              <Button size="sm" variant="outline" className="h-8 text-xs" onClick={handleCustomDates}>
                Appliquer
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Loading / Error */}
      {loading && (
        <div className="flex items-center justify-center h-48">
          <Loader2 className="h-8 w-8 animate-spin text-emerald-500" />
          <span className="ml-3 text-muted-foreground">Chargement des donnees...</span>
        </div>
      )}

      {error && !loading && (
        <Card className="border-red-200 bg-red-50 dark:bg-red-900/10">
          <CardContent className="p-4 text-red-600 dark:text-red-400">
            {error}
          </CardContent>
        </Card>
      )}

      {data && !loading && s && (
        <>
          {/* 4 KPI Cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <KPICard
              title="Chiffre d'Affaires"
              value={fmtMAD(s.revenue)}
              subtitle={`${s.invoiceCount} factures`}
              icon={<DollarSign className="h-5 w-5" />}
              color="emerald"
            />
            <KPICard
              title="Achats (PO)"
              value={fmtMAD(s.costsPO)}
              subtitle={`${s.poCount} commandes | PINV: ${fmtMAD(s.costsPINV)}`}
              icon={<ShoppingCart className="h-5 w-5" />}
              color="blue"
            />
            <KPICard
              title="Marge Brute"
              value={fmtMAD(s.grossMargin)}
              subtitle={`Taux: ${fmtPct(s.marginRate)}`}
              icon={s.marginRate > 0 ? <ArrowUpRight className="h-5 w-5" /> : <ArrowDownRight className="h-5 w-5" />}
              color={s.marginRate > 15 ? "emerald" : "amber"}
              trend={fmtPct(s.marginRate)}
              trendUp={s.marginRate > 15}
            />
            <KPICard
              title="Encaissements"
              value={fmtMAD(s.amountCollected)}
              subtitle={`Reste a encaisser: ${fmtMAD(s.amountDue)}`}
              icon={<Wallet className="h-5 w-5" />}
              color="purple"
            />
          </div>

          {/* Monthly Chart */}
          {data.monthly.length > 0 && (
            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-base">Evolution Mensuelle</CardTitle>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={320}>
                  <ComposedChart data={data.monthly} margin={{ top: 5, right: 20, bottom: 5, left: 10 }}>
                    <CartesianGrid strokeDasharray="3 3" opacity={0.3} />
                    <XAxis dataKey="month" tick={{ fontSize: 11 }} />
                    <YAxis tickFormatter={(v) => fmtCompact(v)} tick={{ fontSize: 11 }} />
                    <Tooltip content={<CustomTooltip />} />
                    <Legend wrapperStyle={{ fontSize: 12 }} />
                    <Bar dataKey="revenue" name="Ventes" fill="#10B981" radius={[4, 4, 0, 0]} barSize={24} />
                    <Bar dataKey="costs" name="Achats PO" fill="#3B82F6" radius={[4, 4, 0, 0]} barSize={24} />
                    <Line type="monotone" dataKey="margin" name="Marge" stroke="#F59E0B" strokeWidth={2} dot={false} />
                  </ComposedChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>
          )}

          {/* Top 10 Clients */}
          {data.topClients.length > 0 && (
            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-base flex items-center gap-2">
                  <FileText className="h-4 w-4 text-emerald-500" />
                  Top 10 Clients — Ventes
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="border-b text-muted-foreground text-left">
                        <th className="py-2 px-2 w-8">#</th>
                        <th className="py-2 px-2">Client</th>
                        <th className="py-2 px-2 text-right">Factures</th>
                        <th className="py-2 px-2 text-right">CA</th>
                        <th className="py-2 px-2 text-right w-20">% CA</th>
                        <th className="py-2 px-2 w-32"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {data.topClients.map((c, i) => (
                        <tr key={i} className="border-b last:border-0 hover:bg-muted/30">
                          <td className="py-2 px-2 text-muted-foreground">{i + 1}</td>
                          <td className="py-2 px-2 font-medium truncate max-w-[250px]" title={c.name}>
                            {c.name}
                          </td>
                          <td className="py-2 px-2 text-right">{c.count}</td>
                          <td className="py-2 px-2 text-right font-semibold">{fmtMAD(c.total)}</td>
                          <td className="py-2 px-2 text-right text-muted-foreground">{fmtPct(c.pct)}</td>
                          <td className="py-2 px-2">
                            <div className="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-2">
                              <div
                                className="bg-emerald-500 h-2 rounded-full transition-all"
                                style={{ width: `${Math.min(c.pct, 100)}%` }}
                              />
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Top 10 Suppliers PO vs PINV */}
          {data.topSuppliers.length > 0 && (
            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-base flex items-center gap-2">
                  <ShoppingCart className="h-4 w-4 text-blue-500" />
                  Top 10 Fournisseurs — Achats
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="border-b text-muted-foreground text-left">
                        <th className="py-2 px-2 w-8">#</th>
                        <th className="py-2 px-2">Fournisseur</th>
                        <th className="py-2 px-2 text-right">Commandes PO</th>
                        <th className="py-2 px-2 text-right">Nb PO</th>
                        <th className="py-2 px-2 text-right">Factures PINV</th>
                        <th className="py-2 px-2 text-right">Nb PINV</th>
                      </tr>
                    </thead>
                    <tbody>
                      {data.topSuppliers.map((sup, i) => (
                        <tr key={i} className="border-b last:border-0 hover:bg-muted/30">
                          <td className="py-2 px-2 text-muted-foreground">{i + 1}</td>
                          <td className="py-2 px-2 font-medium truncate max-w-[250px]" title={sup.name}>
                            {sup.name}
                          </td>
                          <td className="py-2 px-2 text-right font-semibold text-blue-600 dark:text-blue-400">
                            {fmtMAD(sup.totalPO)}
                          </td>
                          <td className="py-2 px-2 text-right">{sup.countPO}</td>
                          <td className="py-2 px-2 text-right text-muted-foreground">
                            {sup.totalPINV > 0 ? fmtMAD(sup.totalPINV) : "-"}
                          </td>
                          <td className="py-2 px-2 text-right text-muted-foreground">
                            {sup.countPINV > 0 ? sup.countPINV : "-"}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </CardContent>
            </Card>
          )}
        </>
      )}
    </div>
  );
}

// ── KPI Card Component ────────────────────────────────────

function KPICard({
  title,
  value,
  subtitle,
  icon,
  color,
  trend,
  trendUp,
}: {
  title: string;
  value: string;
  subtitle?: string;
  icon: React.ReactNode;
  color: string;
  trend?: string;
  trendUp?: boolean;
}) {
  const colorMap: Record<string, string> = {
    emerald: "bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20 dark:text-emerald-400",
    blue: "bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400",
    amber: "bg-amber-50 text-amber-600 dark:bg-amber-900/20 dark:text-amber-400",
    purple: "bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-400",
  };

  return (
    <Card>
      <CardContent className="p-4">
        <div className="flex items-center justify-between mb-3">
          <span className="text-sm text-muted-foreground">{title}</span>
          <div className={cn("p-2 rounded-lg", colorMap[color])}>
            {icon}
          </div>
        </div>
        <div className="text-2xl font-bold">{value}</div>
        <div className="flex items-center gap-2 mt-1">
          {trend && (
            <Badge variant={trendUp ? "default" : "destructive"} className="text-xs px-1.5 py-0">
              {trendUp ? <ArrowUpRight className="h-3 w-3 mr-0.5" /> : <ArrowDownRight className="h-3 w-3 mr-0.5" />}
              {trend}
            </Badge>
          )}
          {subtitle && (
            <span className="text-xs text-muted-foreground">{subtitle}</span>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
